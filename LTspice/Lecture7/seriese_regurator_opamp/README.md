# オペアンプを用いたリニアレギュレータ

## 概要

オペアンプ（演算増幅器）によるフィードバック制御を用いた高精度リニアレギュレータのシミュレーションです。出力電圧を抵抗分圧してフィードバックすることで、負荷変動に対して安定した出力電圧を実現します。

## 回路構成

### 主要素子
- **電源電圧**: V4 = 10 V
- **基準電圧**: V3 = PULSE(0, 5, 0.2m, 10n, 10n, 10m)
- **オペアンプ電源**: V5 = +10 V、V6 = 0 V（GND）
- **オペアンプ**: U2 (UniversalOpamp2)
- **トランジスタ**: Q1 (2N2222, npn型)
- **フィードバック抵抗**: R3 = 6 kΩ、R4 = 12 kΩ
- **負荷抵抗**: R2 = 10 Ω

### 回路の特徴
- オペアンプによる誤差増幅とフィードバック制御
- 抵抗分圧により任意の出力電圧を設定可能
- 負荷変動に対する高い安定性

## 動作原理

### フィードバック制御の基本

1. **出力電圧の分圧**
   - 出力電圧 V_out を R3 と R4 で分圧
   - フィードバック電圧: V_fb = V_out × R4 / (R3 + R4)

2. **誤差検出**
   - オペアンプの非反転入力(+): V_ref = 5 V
   - オペアンプの反転入力(-): V_fb
   - 誤差電圧: V_error = V_ref - V_fb

3. **誤差増幅**
   - オペアンプが誤差を大きく増幅
   - 出力: V_opamp = A_v × (V_ref - V_fb)
   - A_v（電圧増幅度）: 10^5 ~ 10^7

4. **トランジスタ制御**
   - オペアンプ出力がトランジスタのベースを駆動
   - V_out が V_ref より低い → ベース電流増加 → V_out 上昇
   - V_out が V_ref より高い → ベース電流減少 → V_out 下降

### 仮想短絡（Virtual Short）

フィードバックにより、オペアンプの入力端子間の電圧差はほぼ 0 になります：
```
V_ref ≈ V_fb
```

これを「仮想短絡」と呼びます。

### 出力電圧の計算

仮想短絡より：
```
V_ref = V_fb = V_out × R4 / (R3 + R4)
```

したがって：
```
V_out = V_ref × (R3 + R4) / R4
      = V_ref × (6k + 12k) / 12k
      = V_ref × 1.5
```

V_ref = 5 V のとき：
```
V_out = 5 × 1.5 = 7.5 V
```

## シミュレーション設定

### 過渡解析
```
.tran 1m
```
- 解析時間：1 ms

### 基準電圧のパルス入力
```
V3: PULSE(0 5 0.2m 10n 10n 10m)
```
- 0.2 ms 後に 0 V → 5 V にステップ変化
- 立ち上がり時間：10 ns
- パルス幅：10 ms

この設定により、過渡応答（起動特性）を観察できます。

## 理論計算

### 定常状態（V_ref = 5 V）

**出力電圧**:
```
V_out = V_ref × (R3 + R4) / R4
      = 5 × (6000 + 12000) / 12000
      = 5 × 1.5
      = 7.5 V
```

**フィードバック電圧**:
```
V_fb = V_out × R4 / (R3 + R4)
     = 7.5 × 12000 / 18000
     = 5.0 V
```

確かに V_fb = V_ref = 5 V となっています（仮想短絡）。

**負荷電流**（R2 = 10 Ω の場合）:
```
I_out = V_out / R2 = 7.5 / 10 = 0.75 A
```

**コレクタ電流**:
```
I_C ≈ I_out = 0.75 A
```

**ベース電流**（h_FE = 100 と仮定）:
```
I_B = I_C / h_FE = 0.75 / 100 = 7.5 mA
```

## 観察項目

### 確認すべき波形
1. **V(n006)**: 基準電圧（パルス入力）
2. **V(n008)**: 出力電圧
3. **V(n010)**: フィードバック電圧
4. **V(n007)**: オペアンプ出力（ベース電圧）
5. **I(R2)**: 負荷電流
6. **IC(Q1)**: コレクタ電流

### 過渡応答の観察
- 0.2 ms でパルス入力が立ち上がる
- 出力電圧が 0 V → 7.5 V に変化する過程
- オペアンプ出力の変化
- フィードバック電圧が V_ref に収束する様子

### 定常状態の確認
- V_fb ≈ V_ref = 5 V（仮想短絡）
- V_out = 7.5 V（設計値）
- 負荷電流の安定性

## 実験課題

### 基礎課題
1. 出力電圧の実測値を求め、理論値（7.5 V）と比較せよ
2. フィードバック電圧が基準電圧に等しいことを確認せよ
3. 過渡応答時間（起動時間）を測定せよ

### 発展課題
1. 負荷抵抗 R2 を変化させて、負荷レギュレーションを評価せよ
   ```.step param R list 5 10 20 50```

2. フィードバック抵抗比を変えて、出力電圧を変更せよ
   - R3 = 3kΩ、R4 = 12kΩ の場合の V_out を求めよ
   - R3 = 12kΩ、R4 = 12kΩ の場合の V_out を求めよ

3. 基準電圧 V_ref を変化させて、出力電圧の追従性を確認せよ

4. オペアンプの出力電圧（ベース電圧）の変化範囲を調べよ
   - 最小値と最大値を測定

## この回路の利点

### ツェナーダイオード回路からの改善
1. **高精度な電圧制御**
   - 負荷変動に対する出力電圧の変動が非常に小さい
   - 負荷レギュレーション: < 0.01 V 程度

2. **任意の出力電圧設定**
   - 抵抗比 (R3 + R4) / R4 により自由に設定可能
   - V_out = V_ref × (R3 + R4) / R4

3. **自動調整機能**
   - 負荷や入力電圧が変化しても自動的に補正
   - フィードバックループによる安定化

## この回路の限界

### BJTの電流容量
- 2N2222 の最大コレクタ電流：約 800 mA
- 大電流負荷には対応できない
- 放熱設計が必要

### 解決策
- **MOSFET を使用**（seriese_regurator_opamp_mosfet）
- より大きな電流を扱える
- ゲート駆動電流がほぼゼロ（高効率）

## 参考：オペアンプの特性

### 理想オペアンプの特性
- **電圧増幅度**: A_v → ∞
- **入力抵抗**: R_in → ∞
- **出力抵抗**: R_out → 0
- **帯域幅**: BW → ∞

### 実際のオペアンプ
- **電圧増幅度**: 10^5 ~ 10^7
- **入力抵抗**: 10^6 ~ 10^9 Ω
- **出力抵抗**: 10^2 Ω程度
- **帯域幅**: 数 MHz ~ 数百 MHz

### フィードバックの効果
- オープンループゲインは非常に大きいが不安定
- フィードバックにより安定した動作を実現
- 仮想短絡により高精度な制御が可能

## 次のステップ

大電流対応のために：
- **MOSFET を用いたリニアレギュレータ**（seriese_regurator_opamp_mosfet）
- パワーMOSFETの使用
- より大きな負荷電流に対応
- ゲート駆動の利点を活用
